<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script crossorigin="anonymous" integrity="sha512-n/4gHW3atM3QqRcbCn6ewmpxcLAHGaDjpEBu4xZd47N0W2oQ+6q7oc3PXstrJYXcbNU1OHdQ1T7pAP+gi5Yu8g==" src="https://lib.baomitu.com/jquery/3.6.0/jquery.js"></script>
    <title>fabric demo </title>
</head>
<body>
    <div style="position: relative;width: 410px;height: 410px;" >
        <canvas id="br" width="400" height="400" 
          style="position: absolute; 
          left: 0; top: 0;
           z-index: 0;border: 1px solid royalblue;"></canvas>
        <canvas id="tr" width="400" height="100" 
          style="position: absolute; 
          left: 0; top: 0; 
          z-index: 1;border: 1px solid coral;"></canvas>
       <canvas id="bl" width="100" height="400" 
          style="position: absolute; 
          left: 0; top: 0; 
          z-index: 1;border: 1px solid blueviolet;"></canvas>
       <canvas id="tl" width="100" height="100" 
          style="position: absolute; 
          left: 0; top: 0; 
          z-index: 1;border: 1px solid aquamarine;"></canvas>
    </div>
    <button id="btn">freeze</button>
    
<script>
    var br = new fabric.Canvas('br');
    var bl = new fabric.Canvas('bl');
    var tr = new fabric.Canvas('tr');
    var tl = new fabric.Canvas('tl');
    document.getElementsByClassName("canvas-container")[0].setAttribute("style","position:absolute")
    document.getElementsByClassName("canvas-container")[1].setAttribute("style","position:absolute")
    document.getElementsByClassName("canvas-container")[2].setAttribute("style","position:absolute")
    document.getElementsByClassName("canvas-container")[3].setAttribute("style","position:absolute")
    const imgURL = `https://i.kym-cdn.com/entries/icons/original/000/005/574/takemymoney.jpg`;
    let freeze = true;
    let btn = document.getElementById("btn");
    

    let rect = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:1,
        width:150,
        height:150,
        left: 30,
        top: 30,
        fill:"aquamarine",
    })

    let rect2 = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:1,
        width:150,
        height:150,
        left: 30,
        top: 30,
        fill:"blueviolet",
    })
    let rect3 = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:1,
        width:150,
        height:150,
        left: 30,
        top: 30,
        fill:"coral",
    })
    let rect4 = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:1,
        width:150,
        height:150,
        left: 30,
        top: 30,
        fill:"royalblue",
    })

    let recta = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:2,
        width:150,
        height:150,
        left: 200,
        top: 200,
        fill:"aquamarine",
    })

    let rect2a = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:2,
        width:150,
        height:150,
        left: 200,
        top: 200,
        fill:"blueviolet",
    })
    let rect3a = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:2,
        width:150,
        height:150,
        left: 200,
        top: 200,
        fill:"coral",
    })
    let rect4a = new fabric.Rect({
		deltaX:0,
		deltaY:0,
        id:2,
        width:150,
        height:150,
        left: 200,
        top: 200,
        fill:"royalblue",
    })
    new fabric.Image.fromURL(imgURL, img => {
        img.set({
            deltaX:0,
		    deltaY:0,
            left:0,
            top:0,
        })
        img.scaleToHeight(200);
        img.scaleToWidth(200);
        br.add(img)
    });
    new fabric.Image.fromURL(imgURL, img => {
        img.set({
            deltaX:0,
		    deltaY:0,
            left:0,
            top:0,
        })
        img.scaleToHeight(200);
        img.scaleToWidth(200);
        bl.add(img)
    });
    new fabric.Image.fromURL(imgURL, img => {
        img.set({
            deltaX:0,
		    deltaY:0,
            left:0,
            top:0,
        })
        img.scaleToHeight(200);
        img.scaleToWidth(200);
        tr.add(img)
    });
    new fabric.Image.fromURL(imgURL, img => {
        img.set({
            deltaX:0,
		    deltaY:0,
            left:0,
            top:0,
        })
        img.scaleToHeight(200);
        img.scaleToWidth(200);
        tl.add(img)
    });
    br.add(rect4);
    bl.add(rect2);
    tr.add(rect3);
    tl.add(rect);
    br.add(rect4a);
    bl.add(rect2a);
    tr.add(rect3a);
    tl.add(recta);
    


    let events = {
        "object:rotating": (canvas) => {
            return (evt)=>{
                console.log("object:rotating")
                let obj = canvas.getObjects().find(x=>x.id === evt.target.id);
                obj.set({
                    left: evt.target.left,
                    top: evt.target.top,
                    angle: evt.target.angle,
                })
                canvas.renderAll();
            }
        },
        "object:moving": (canvas) => {
            return (evt)=>{
                console.log("object:scaling")
                let obj = canvas.getObjects().find(x=>x.id === evt.target.id);
                obj.set({           
                    left: evt.target.left,
                    top: evt.target.top,
                })
                canvas.renderAll();
            }
        },
        "object:scaling": (canvas) => {
            return (evt)=>{
                console.log("object:scaling")
                let obj = canvas.getObjects().find(x=>x.id === evt.target.id);
                obj.set({
                    left: evt.target.left,
                    top: evt.target.top,
                    scaleX: evt.target.scaleX,
                    scaleY: evt.target.scaleY,
                })
                canvas.renderAll();
            }
        },
        "selection:created" : (canvas) => {
            return (evt)=>{
                console.log("selection:created")
                reset(evt);
                let obj = canvas.getObjects().find(x=>x.id === evt.target.id);
                canvas.setActiveObject(obj);
            }
        },
        "selection:cleared": (canvas) => {
            return (evt)=>{
                console.log("selection:cleared")
                canvas.discardActiveObject();
                canvas.renderAll();
            }
        },
        "selection:updated": (canvas) => {
            return (evt)=>{
                console.log("selection:updated")
                let obj = canvas.getObjects().find(x=>x.id === evt.target.id);
                if (canvas.getActiveObject()?.id === obj.id) {
                    return
                }
                canvas.setActiveObject(obj);
                canvas.renderAll();
            }
        },
        //  测试用 在对象上滚动向各个方法移动 模拟滚动条
        // 滚动条只有 向右和向下移动  移动后才能向反方向移动
        "mouse:wheel": (canvas) => {
            return (evt)=>{

                console.log("wheel")
                tl.discardActiveObject();
                tr.discardActiveObject();
                br.discardActiveObject();
                bl.discardActiveObject();
                let deltaX = evt.e.deltaX/10;
                let deltaY = evt.e.deltaY/10;
                tr.getObjects().forEach(x=> x.set({
                    left:x.left + deltaX,
                    deltaX:x.deltaX + deltaX?? 0,
                }));
                br.getObjects().forEach(x=> x.set({
                    left:x.left + deltaX,
                    deltaX:x.deltaX + deltaX?? 0,
                    top:x.top + deltaY,
                    deltaY:x.deltaY + deltaY?? 0,
                }));
                bl.getObjects().forEach(x=> x.set({
                    top:x.top + deltaY,
                    deltaY:x.deltaY + deltaY?? 0,
                }));
                
                tr.getObjects().forEach(x=> {
                    console.log(x.left,"->left tr top->",x.top)
                    // console.log(x.aCoords?.tl)

                    let left =  100 - x.left;
                    left = left < 0 ? 0 : left;

                    x.clipPath = new fabric.Rect({
                        width: x.width,
                        height: x.height,
                        left: -(x.width / 2) + left/x.scaleX ,
                        top: -(x.height / 2) ,
                    });
                    x.dirty = true;
                    x.setCoords();
                });
                br.getObjects().forEach(x=> {
                    console.log(x.left,"->left br top->",x.top);
                    // console.log(x.aCoords?.tl)
                    
                    let left =  100 - x.left;
                    left = left < 0 ? 0 : left;

                    let top = 100 - x.top;
                    top = top < 0 ? 0 : top;

                    x.clipPath = new fabric.Rect({
                        width: x.width,
                        height: x.height,
                        left: -(x.width / 2) + left/x.scaleX ,
                        top: -(x.height / 2) + top /x.scaleY,
                    });
                    x.setCoords();
                    x.dirty = true;
                });
                
                bl.getObjects().forEach(x=> {
                    console.log(x.left,"->left bl top->",x.top)
                    // console.log(x.aCoords?.tl)

                    let top = 100 - x.top;
                    top = top < 0 ? 0 : top;

                    x.clipPath = new fabric.Rect({
                        width: x.width,
                        height: x.height,
                        left: -(x.width / 2),
                        top: -(x.height / 2) + top/x.scaleY ,
                    });
                    x.setCoords();
                    x.dirty = true;
                });
                // let bro = br.getObjects().find(x=>x.id === evt.target.id);

                // if (!!!tro.aCoords || tro.aCoords?.tl.x >= 100) {
                //     return;
                // } 
                // tro.clipPath = new fabric.Rect({
                //     width: tro.width,
                //     height: tro.height,
                //     left: -(tro.width / 2) + (100 -tro.left) ,
                //     top: -(tro.height / 2),
                // });
                // bro.clipPath = new fabric.Rect({
                //     width: bro.width,
                //     height: bro.height,
                //     left: -(bro.width / 2) + (100 -tro.left),
                //     top: -(bro.height / 2),
                // });
                // tro.dirty = true
                // bro.dirty = true
                
                tl.renderAll();
                tr.renderAll();
                br.renderAll();
                bl.renderAll();
            }
        },
    }

    btn.addEventListener("click",() => {
        if (freeze) {
            console.log("Defrosting")
            reset();
            for (key of Object.keys(events)) {
                br.off(key)
            }
            
            tr.dispose();
            tl.dispose();
            bl.dispose();
            document.getElementById("tr").remove();
            document.getElementById("tl").remove();
            document.getElementById("bl").remove();
            freeze = false;
        } else {
            console.log("Frosting")
         
        }
    });
    function addEvents(canvas,toCanvas) {
        if (!!! canvas) return;
        for (key of Object.keys(events)) {
            for (toC of toCanvas) {
                if (!!! toC) return;
                canvas.on(key,events[key](toC));
            }
        }
    }

    function reset(evt) {
        br.getObjects().forEach(x=>{
            console.log(x.deltaX,"<-deltaX br deltaY->",x.deltaY,x.top,"<- top left->",x.left)
            x.set({
                left: x.left - x.deltaX?? 0, 
                top: x.top - x.deltaY?? 0,
                deltaX: 0,
                deltaY: 0,
            });
            x.setCoords();
            x.clipPath = null;
            x.dirty = true;
        });
        br.renderAll();
        if (!freeze) return;
        tr.getObjects().forEach(x=>{
            console.log(x.deltaX,"<-deltaX tr deltaY->",x.deltaY,x.top,"<- top left->",x.left)
            x.set({
                left: x.left - x.deltaX?? 0, 
                top: x.top - x.deltaY?? 0,
                deltaX: 0,
                deltaY: 0,
            });
            // 图像复位后需要逐个重新定位
            x.setCoords();
            x.clipPath = null;
            x.dirty = true;
        });
        
        bl.getObjects().forEach(x=>{
            console.log(x.deltaX,"<-deltaX bl deltaY->",x.deltaY,x.top,"<- top left->",x.left)
            x.set({
                left: x.left - x.deltaX?? 0, 
                top: x.top - x.deltaY?? 0,
                deltaX: 0,
                deltaY: 0,
            });
            x.setCoords();
            x.clipPath = null;
            x.dirty = true;
        });
        tr.renderAll();
        
        bl.renderAll();

    }


    
    addEvents(tr,[tl,br,bl]);
    addEvents(tl,[tr,br,bl]);
    addEvents(br,[tl,tr,bl]);
    addEvents(bl,[tl,br,tr]);
</script>
</body>
</html>